#!/bin/sh /etc/rc.common
# Copyright (C) 2006-2011 OpenWrt.org

START=80
STOP=99

USE_PROCD=1
PROG=/bin/adb.sh
OOM_ADJ=-17

start_service() {
	if [ -e /sys/class/android_usb/android0 ]; then
		echo 0 > /sys/class/android_usb/android0/enable
		echo 18d1 > /sys/class/android_usb/android0/idVendor
		echo D002 > /sys/class/android_usb/android0/idProduct
		echo adb > /sys/class/android_usb/android0/functions
		echo 1 > /sys/class/android_usb/android0/enable
	else
		mount -t configfs none /sys/kernel/config
		mkdir /sys/kernel/config/usb_gadget/g1
		echo "0x18d1" > /sys/kernel/config/usb_gadget/g1/idVendor
		echo "0xD002" > /sys/kernel/config/usb_gadget/g1/idProduct
		mkdir /sys/kernel/config/usb_gadget/g1/strings/0x409
		echo "20080411" > /sys/kernel/config/usb_gadget/g1/strings/0x409/serialnumber
		echo "Android" > /sys/kernel/config/usb_gadget/g1/strings/0x409/manufacturer
		mkdir /sys/kernel/config/usb_gadget/g1/functions/ffs.adb
		mkdir /sys/kernel/config/usb_gadget/g1/configs/c.1
		echo 0xc0 > /sys/kernel/config/usb_gadget/g1/configs/c.1/bmAttributes
		echo 500 > /sys/kernel/config/usb_gadget/g1/configs/c.1/MaxPower
		mkdir /sys/kernel/config/usb_gadget/g1/configs/c.1/strings/0x409
		ln -s /sys/kernel/config/usb_gadget/g1/functions/ffs.adb/ /sys/kernel/config/usb_gadget/g1/configs/c.1/ffs.adb
		mkdir /sys/kernel/config/usb_gadget/g1/functions/mass_storage.usb0
		ln -s /sys/kernel/config/usb_gadget/g1/functions/mass_storage.usb0/ /sys/kernel/config/usb_gadget/g1/configs/c.1/mass_storage.usb0
		mkdir /dev/usb-ffs
		mkdir /dev/usb-ffs/adb
		mount -o uid=2000,gid=2000 -t functionfs adb /dev/usb-ffs/adb/
	fi
	procd_open_instance
	procd_set_param oom_adj $OOM_ADJ
	procd_set_param command $PROG -D
	procd_close_instance
}

shutdown() {
	echo shutdown
}
